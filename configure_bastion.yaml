# vim: set ft=ansible:
---
- name: Configure the bastion host
  hosts: bastion
  gather_facts: no
  become: True
  become_method: sudo
  vars:
    rhn_username: "{{ lookup('env','rhn_username') }}"
    rhn_password: "{{ lookup('env','rhn_password') }}"

  tasks:
  - name: Copy partition script
    copy:
      src: ./partition.sh
      dest: /tmp/partition.sh
      owner: root
      mode: 0700

  - name: Execute the partition script
    shell: /tmp/partition.sh

  - name: Format EBS volume
    filesystem:
      fstype: xfs
      dev: /dev/xvdb1

  - name: Make the yum html directory
    file:
      path: "/var/www/html"
      state: directory
      mode: 0755
      recurse: yes

  - name: Mount the volume
    mount:
      name: "/var/www/html"
      src: /dev/xvdb1
      fstype: xfs
      state: mounted

  - name: Make the repo directories
    file:
      path: "/var/www/html/{{ item }}"
      state: directory
      mode: 0755
    with_items:
      - "rhel-7-server-rpms"
      - "rhel-7-server-extras-rpms"
      - "rhel-7-server-ose-3.2-rpms"

  - name: Get rid of RHUI repo files
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - "/etc/yum.repos.d/redhat-rhui.repo"
      - "/etc/yum.repos.d/redhat-rhui-client-config.repo"
      - "/etc/yum.repos.d/rhui-load-balancers.repo"

  - name: Subscribe to RHN
    redhat_subscription:
      state: present
      username: "{{ rhn_username }}"
      password: "{{ rhn_password }}"
      autosubscribe: true

  # Currently no support for repo manipulation in redhat_subscription
  - name: Disable all repos
    command: subscription-manager repos --disable="*"

  - name: Enable OpenShift repos
    command: subscription-manager repos --enable="{{ item }}"
    with_items:
      - "rhel-7-server-rpms"
      - "rhel-7-server-extras-rpms"
      - "rhel-7-server-ose-3.2-rpms"

  - name: Install httpd
    yum:
      name: httpd
      state: present

  - name: Start and enable httpd
    service:
      name: httpd
      state: started
      enabled: yes

  - name: Restore SELinux context
    command: restorecon -R /var/www/html

  - name: Sync OpenShift repos
    command: reposync -n -r "{{ item }}" -p "/var/www/html/"
    with_items:
      - "rhel-7-server-rpms"
      - "rhel-7-server-extras-rpms"
      - "rhel-7-server-ose-3.2-rpms"

  - name: Install createrepo
    yum:
      name: createrepo
      state: present

  - name: Set up local yum repos
    command: createrepo --database "/var/www/html/{{ item }}/Packages"
    with_items:
      - "rhel-7-server-rpms"
      - "rhel-7-server-extras-rpms"
      - "rhel-7-server-ose-3.2-rpms"
